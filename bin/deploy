#!/bin/bash

FUNCTIONS=("scrapper" "notifier")

ZIP_FILE_SUFFIX="function.zip"

# Ensure the script exits on any error
set -e

# Check if the ZIP file(s) exist
for FUNCTION in "${FUNCTIONS[@]}"; do
    ZIP_FILE="${FUNCTION}_${ZIP_FILE_SUFFIX}"
    if [ ! -f "$ZIP_FILE" ]; then
        echo "Error: ${ZIP_FILE} does not exist. Building source"
        ./bin/build
        break
    fi
done

# load secrets that are stored in .env
set -o allexport; source .env; set +o allexport

sam build
sam deploy \
    --profile personal \
    --parameter-overrides SourceEmailParameter="$SOURCE_EMAIL" BCCAddressesParameter="$BCC_ADDRESSES" ReplyToAddressesParameter="$REPLY_TO_ADDRESSES" CustomDomainEmailIdentity="$EMAIL_IDENTITY"

echo "Deployment completed successfully!"